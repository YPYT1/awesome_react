# è·¯ç”±é”™è¯¯å¤„ç†

## æ¦‚è¿°

React Router v6æä¾›äº†å¼ºå¤§çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå…è®¸åœ¨è·¯ç”±å±‚é¢æ•è·å’Œå¤„ç†å„ç§é”™è¯¯ã€‚é€šè¿‡errorElementå’ŒuseRouteErrorç­‰APIï¼Œå¯ä»¥åˆ›å»ºä¼˜é›…çš„é”™è¯¯è¾¹ç•Œï¼Œæä¾›è‰¯å¥½çš„é”™è¯¯æ¢å¤ä½“éªŒã€‚æœ¬æ–‡æ·±å…¥æ¢è®¨è·¯ç”±é”™è¯¯å¤„ç†çš„å„ç§æ¨¡å¼å’Œæœ€ä½³å®è·µã€‚

## åŸºç¡€é”™è¯¯å¤„ç†

### errorElementåŸºç¡€

```jsx
import { createBrowserRouter, useRouteError, isRouteErrorResponse } from 'react-router-dom';

// åŸºç¡€é”™è¯¯è¾¹ç•Œç»„ä»¶
function ErrorBoundary() {
  const error = useRouteError();

  if (isRouteErrorResponse(error)) {
    // è¿™æ˜¯ç”±loaderæˆ–actionä¸»åŠ¨æŠ›å‡ºçš„Responseé”™è¯¯
    return (
      <div className="error-page">
        <h1>{error.status} {error.statusText}</h1>
        <p>{error.data}</p>
      </div>
    );
  }

  // æœªé¢„æœŸçš„é”™è¯¯
  return (
    <div className="error-page">
      <h1>Oops! Something went wrong</h1>
      <p>{error.message || 'Unknown error occurred'}</p>
      {process.env.NODE_ENV === 'development' && (
        <pre className="error-stack">{error.stack}</pre>
      )}
    </div>
  );
}

// è·¯ç”±é…ç½®withé”™è¯¯å¤„ç†
const router = createBrowserRouter([
  {
    path: '/',
    element: <Layout />,
    errorElement: <ErrorBoundary />,
    children: [
      {
        index: true,
        element: <Home />
      },
      {
        path: 'users/:userId',
        element: <UserProfile />,
        loader: userLoader,
        errorElement: <UserErrorBoundary />
      }
    ]
  }
]);

// Loaderä¸­æŠ›å‡ºé”™è¯¯
async function userLoader({ params }) {
  const { userId } = params;
  
  const response = await fetch(`/api/users/${userId}`);
  
  if (response.status === 404) {
    throw new Response('User not found', { status: 404 });
  }
  
  if (response.status === 403) {
    throw new Response('Access forbidden', { status: 403 });
  }
  
  if (!response.ok) {
    throw new Response('Failed to load user', { status: 500 });
  }
  
  return response.json();
}

// ç”¨æˆ·ç‰¹å®šçš„é”™è¯¯è¾¹ç•Œ
function UserErrorBoundary() {
  const error = useRouteError();
  const navigate = useNavigate();

  if (isRouteErrorResponse(error)) {
    if (error.status === 404) {
      return (
        <div className="error-page">
          <h1>User Not Found</h1>
          <p>The user you're looking for doesn't exist.</p>
          <button onClick={() => navigate('/users')}>
            View All Users
          </button>
        </div>
      );
    }

    if (error.status === 403) {
      return (
        <div className="error-page">
          <h1>Access Denied</h1>
          <p>You don't have permission to view this user's profile.</p>
          <button onClick={() => navigate('/')}>
            Go Home
          </button>
        </div>
      );
    }
  }

  return (
    <div className="error-page">
      <h1>Error Loading User</h1>
      <p>Something went wrong while loading the user profile.</p>
      <button onClick={() => navigate(0)}>
        Try Again
      </button>
      <button onClick={() => navigate('/users')}>
        Back to Users
      </button>
    </div>
  );
}
```

### åµŒå¥—é”™è¯¯è¾¹ç•Œ

```jsx
// å¤šå±‚é”™è¯¯è¾¹ç•Œ
const router = createBrowserRouter([
  {
    path: '/',
    element: <RootLayout />,
    errorElement: <RootErrorBoundary />,
    children: [
      {
        index: true,
        element: <Home />
      },
      {
        path: 'dashboard',
        element: <DashboardLayout />,
        errorElement: <DashboardErrorBoundary />,
        children: [
          {
            index: true,
            element: <DashboardHome />
          },
          {
            path: 'analytics',
            element: <Analytics />,
            loader: analyticsLoader,
            errorElement: <AnalyticsErrorBoundary />
          },
          {
            path: 'settings',
            element: <Settings />,
            loader: settingsLoader,
            errorElement: <SettingsErrorBoundary />
          }
        ]
      }
    ]
  }
]);

// æ ¹çº§é”™è¯¯è¾¹ç•Œ - å¤„ç†æœ€ä¸¥é‡çš„é”™è¯¯
function RootErrorBoundary() {
  const error = useRouteError();

  return (
    <div className="root-error">
      <div className="error-container">
        <h1>Application Error</h1>
        <p>We're sorry, but something went wrong with the application.</p>
        
        {isRouteErrorResponse(error) && (
          <div className="error-details">
            <p>Status: {error.status}</p>
            <p>Message: {error.statusText}</p>
          </div>
        )}

        <div className="error-actions">
          <button onClick={() => window.location.href = '/'}>
            Return to Home
          </button>
          <button onClick={() => window.location.reload()}>
            Reload Page
          </button>
        </div>

        {process.env.NODE_ENV === 'development' && error.stack && (
          <details className="error-stack">
            <summary>Error Stack Trace</summary>
            <pre>{error.stack}</pre>
          </details>
        )}
      </div>
    </div>
  );
}

// ä»ªè¡¨æ¿é”™è¯¯è¾¹ç•Œ - ä¿ç•™å¯¼èˆª
function DashboardErrorBoundary() {
  const error = useRouteError();

  return (
    <div className="dashboard-error">
      <aside className="dashboard-sidebar">
        <DashboardNavigation />
      </aside>
      
      <main className="dashboard-content">
        <div className="error-message">
          <h2>Dashboard Error</h2>
          <p>An error occurred while loading this section of the dashboard.</p>
          
          {isRouteErrorResponse(error) && (
            <p className="error-detail">{error.data}</p>
          )}
          
          <div className="error-actions">
            <Link to="/dashboard">Go to Dashboard Home</Link>
            <button onClick={() => window.location.reload()}>
              Try Again
            </button>
          </div>
        </div>
      </main>
    </div>
  );
}

// åˆ†æé¡µé¢é”™è¯¯è¾¹ç•Œ - æœ€å…·ä½“çš„é”™è¯¯å¤„ç†
function AnalyticsErrorBoundary() {
  const error = useRouteError();
  const navigate = useNavigate();

  return (
    <div className="analytics-error">
      <h2>Analytics Error</h2>
      <p>Unable to load analytics data.</p>
      
      {isRouteErrorResponse(error) && error.status === 403 && (
        <div className="permission-error">
          <p>You don't have permission to view analytics.</p>
          <Link to="/dashboard/settings">
            Request Access
          </Link>
        </div>
      )}
      
      {isRouteErrorResponse(error) && error.status === 500 && (
        <div className="server-error">
          <p>Our analytics service is temporarily unavailable.</p>
          <button onClick={() => navigate(0)}>Retry</button>
        </div>
      )}
      
      <Link to="/dashboard">Back to Dashboard</Link>
    </div>
  );
}
```

## é”™è¯¯ç±»å‹å¤„ç†

### HTTPçŠ¶æ€ç é”™è¯¯

```jsx
// ç»Ÿä¸€çš„HTTPé”™è¯¯å¤„ç†
class HTTPError extends Error {
  constructor(status, statusText, data) {
    super(statusText);
    this.status = status;
    this.statusText = statusText;
    this.data = data;
  }
}

// Loaderä¸­åˆ›å»ºç‰¹å®šé”™è¯¯
async function resourceLoader({ params }) {
  const response = await fetch(`/api/resources/${params.id}`);

  switch (response.status) {
    case 404:
      throw new Response('Resource not found', {
        status: 404,
        statusText: 'Not Found'
      });

    case 401:
      throw new Response('Please log in to continue', {
        status: 401,
        statusText: 'Unauthorized'
      });

    case 403:
      throw new Response('You do not have access to this resource', {
        status: 403,
        statusText: 'Forbidden'
      });

    case 429:
      throw new Response('Too many requests. Please try again later.', {
        status: 429,
        statusText: 'Too Many Requests'
      });

    case 503:
      throw new Response('Service temporarily unavailable', {
        status: 503,
        statusText: 'Service Unavailable'
      });

    default:
      if (!response.ok) {
        throw new Response('An unexpected error occurred', {
          status: response.status,
          statusText: 'Server Error'
        });
      }
  }

  return response.json();
}

// çŠ¶æ€ç ç‰¹å®šçš„é”™è¯¯å¤„ç†
function HTTPErrorBoundary() {
  const error = useRouteError();
  const navigate = useNavigate();
  const location = useLocation();

  if (!isRouteErrorResponse(error)) {
    return <GenericErrorPage error={error} />;
  }

  const errorHandlers = {
    404: () => (
      <div className="error-404">
        <h1>404 - Page Not Found</h1>
        <p>The page you're looking for doesn't exist.</p>
        <div className="error-suggestions">
          <h3>You might want to:</h3>
          <ul>
            <li><Link to="/">Go to homepage</Link></li>
            <li><button onClick={() => navigate(-1)}>Go back</button></li>
            <li><Link to="/search">Search our site</Link></li>
          </ul>
        </div>
      </div>
    ),

    401: () => (
      <div className="error-401">
        <h1>Authentication Required</h1>
        <p>{error.data}</p>
        <button onClick={() => {
          navigate('/login', {
            state: { from: location.pathname }
          });
        }}>
          Sign In
        </button>
      </div>
    ),

    403: () => (
      <div className="error-403">
        <h1>Access Denied</h1>
        <p>{error.data}</p>
        <div className="error-actions">
          <Link to="/">Go Home</Link>
          <Link to="/contact">Contact Support</Link>
        </div>
      </div>
    ),

    429: () => (
      <div className="error-429">
        <h1>Too Many Requests</h1>
        <p>You've made too many requests. Please wait a moment before trying again.</p>
        <RateLimitTimer onExpire={() => navigate(0)} />
      </div>
    ),

    500: () => (
      <div className="error-500">
        <h1>Server Error</h1>
        <p>Something went wrong on our end. We're working to fix it.</p>
        <button onClick={() => navigate(0)}>Try Again</button>
      </div>
    ),

    503: () => (
      <div className="error-503">
        <h1>Service Unavailable</h1>
        <p>Our service is temporarily down for maintenance.</p>
        <p>Please check back in a few minutes.</p>
        <ServiceStatusChecker />
      </div>
    )
  };

  const ErrorComponent = errorHandlers[error.status] || (() => (
    <div className="error-generic">
      <h1>{error.status} - {error.statusText}</h1>
      <p>{error.data}</p>
      <button onClick={() => navigate(-1)}>Go Back</button>
    </div>
  ));

  return <ErrorComponent />;
}

// é€Ÿç‡é™åˆ¶è®¡æ—¶å™¨ç»„ä»¶
function RateLimitTimer({ onExpire }) {
  const [remaining, setRemaining] = useState(60);

  useEffect(() => {
    const timer = setInterval(() => {
      setRemaining(prev => {
        if (prev <= 1) {
          clearInterval(timer);
          onExpire();
          return 0;
        }
        return prev - 1;
      });
    }, 1000);

    return () => clearInterval(timer);
  }, [onExpire]);

  return (
    <div className="rate-limit-timer">
      <p>You can try again in {remaining} seconds</p>
    </div>
  );
}

// æœåŠ¡çŠ¶æ€æ£€æŸ¥å™¨
function ServiceStatusChecker() {
  const [status, setStatus] = useState('checking');

  useEffect(() => {
    const checkStatus = async () => {
      try {
        const response = await fetch('/api/health');
        if (response.ok) {
          setStatus('available');
        } else {
          setStatus('unavailable');
        }
      } catch {
        setStatus('unavailable');
      }
    };

    const interval = setInterval(checkStatus, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
    checkStatus();

    return () => clearInterval(interval);
  }, []);

  if (status === 'available') {
    return (
      <div className="service-available">
        <p>Service is back online!</p>
        <button onClick={() => window.location.reload()}>
          Refresh Page
        </button>
      </div>
    );
  }

  return (
    <div className="service-checking">
      <p>Checking service status...</p>
    </div>
  );
}
```

### ç½‘ç»œé”™è¯¯å¤„ç†

```jsx
// ç½‘ç»œé”™è¯¯æ£€æµ‹å’Œå¤„ç†
async function networkAwareLoader({ params }) {
  try {
    const response = await fetch(`/api/data/${params.id}`);
    
    if (!response.ok) {
      throw new Response('Failed to fetch data', {
        status: response.status
      });
    }
    
    return response.json();
    
  } catch (error) {
    // ç½‘ç»œé”™è¯¯
    if (error instanceof TypeError && error.message.includes('fetch')) {
      throw new Response('Network error. Please check your internet connection.', {
        status: 0, // ç‰¹æ®ŠçŠ¶æ€ç è¡¨ç¤ºç½‘ç»œé”™è¯¯
        statusText: 'Network Error'
      });
    }
    
    // è¶…æ—¶é”™è¯¯
    if (error.name === 'AbortError') {
      throw new Response('Request timed out. Please try again.', {
        status: 0,
        statusText: 'Timeout'
      });
    }
    
    throw error;
  }
}

// ç½‘ç»œé”™è¯¯è¾¹ç•Œ
function NetworkErrorBoundary() {
  const error = useRouteError();
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  const navigate = useNavigate();

  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  if (isRouteErrorResponse(error) && error.status === 0) {
    return (
      <div className="network-error">
        <div className="error-icon">
          {isOnline ? 'âš ï¸' : 'ğŸ“¡'}
        </div>
        
        <h1>
          {isOnline ? 'Connection Problem' : 'You are offline'}
        </h1>
        
        <p>
          {isOnline 
            ? 'Unable to connect to the server. Please check your connection and try again.'
            : 'Please check your internet connection and try again.'
          }
        </p>

        <div className="connection-status">
          <div className={`status-indicator ${isOnline ? 'online' : 'offline'}`} />
          <span>{isOnline ? 'Connected' : 'No connection'}</span>
        </div>

        <div className="error-actions">
          <button onClick={() => navigate(0)} disabled={!isOnline}>
            Try Again
          </button>
          <button onClick={() => navigate(-1)}>
            Go Back
          </button>
        </div>

        <NetworkDiagnostics />
      </div>
    );
  }

  return <DefaultErrorBoundary />;
}

// ç½‘ç»œè¯Šæ–­ç»„ä»¶
function NetworkDiagnostics() {
  const [diagnostics, setDiagnostics] = useState(null);

  const runDiagnostics = async () => {
    const results = {
      onlineStatus: navigator.onLine,
      connectionType: navigator.connection?.effectiveType || 'unknown',
      downlink: navigator.connection?.downlink || 'unknown',
      rtt: navigator.connection?.rtt || 'unknown'
    };

    // æµ‹è¯•DNS
    try {
      await fetch('https://dns.google/resolve?name=example.com', {
        mode: 'no-cors'
      });
      results.dns = 'OK';
    } catch {
      results.dns = 'Failed';
    }

    // æµ‹è¯•APIè¿æ¥
    try {
      await fetch('/api/health', {
        method: 'HEAD'
      });
      results.api = 'OK';
    } catch {
      results.api = 'Failed';
    }

    setDiagnostics(results);
  };

  return (
    <div className="network-diagnostics">
      <button onClick={runDiagnostics}>
        Run Network Diagnostics
      </button>

      {diagnostics && (
        <div className="diagnostics-results">
          <h3>Diagnostics Results:</h3>
          <ul>
            <li>Online Status: {diagnostics.onlineStatus ? 'Online' : 'Offline'}</li>
            <li>Connection Type: {diagnostics.connectionType}</li>
            <li>Download Speed: {diagnostics.downlink} Mbps</li>
            <li>Latency: {diagnostics.rtt} ms</li>
            <li>DNS: {diagnostics.dns}</li>
            <li>API Server: {diagnostics.api}</li>
          </ul>
        </div>
      )}
    </div>
  );
}
```

### æƒé™é”™è¯¯å¤„ç†

```jsx
// æƒé™é”™è¯¯ç±»
class PermissionError extends Error {
  constructor(message, requiredPermission, userPermissions) {
    super(message);
    this.name = 'PermissionError';
    this.requiredPermission = requiredPermission;
    this.userPermissions = userPermissions;
  }
}

// å¸¦æƒé™æ£€æŸ¥çš„Loader
async function protectedLoader({ params, context }) {
  const { user, permissions } = context;

  // æ£€æŸ¥è®¤è¯
  if (!user) {
    throw new Response('Authentication required', {
      status: 401,
      statusText: 'Unauthorized'
    });
  }

  // æ£€æŸ¥æƒé™
  const requiredPermission = 'resource:read';
  if (!permissions.includes(requiredPermission)) {
    throw new PermissionError(
      'You do not have permission to view this resource',
      requiredPermission,
      permissions
    );
  }

  // åŠ è½½æ•°æ®
  const data = await fetch(`/api/resources/${params.id}`)
    .then(r => r.json());

  return data;
}

// æƒé™é”™è¯¯è¾¹ç•Œ
function PermissionErrorBoundary() {
  const error = useRouteError();
  const { user } = useAuth();
  const navigate = useNavigate();

  // å¤„ç†PermissionError
  if (error instanceof PermissionError) {
    return (
      <div className="permission-error">
        <h1>Access Denied</h1>
        <p>{error.message}</p>

        <div className="permission-details">
          <h3>Permission Required:</h3>
          <code>{error.requiredPermission}</code>

          <h3>Your Permissions:</h3>
          <ul>
            {error.userPermissions.map(perm => (
              <li key={perm}><code>{perm}</code></li>
            ))}
          </ul>
        </div>

        <div className="error-actions">
          <button onClick={() => navigate('/')}>
            Go Home
          </button>
          <Link to="/upgrade">
            Upgrade Your Account
          </Link>
          <Link to="/contact">
            Request Access
          </Link>
        </div>
      </div>
    );
  }

  // å¤„ç†401é”™è¯¯
  if (isRouteErrorResponse(error) && error.status === 401) {
    return (
      <div className="auth-required">
        <h1>Sign In Required</h1>
        <p>Please sign in to access this page.</p>
        
        <button onClick={() => {
          navigate('/login', {
            state: { from: location.pathname }
          });
        }}>
          Sign In
        </button>

        <p>
          Don't have an account? <Link to="/register">Sign up</Link>
        </p>
      </div>
    );
  }

  return <DefaultErrorBoundary />;
}
```

## é”™è¯¯æ¢å¤ç­–ç•¥

### è‡ªåŠ¨é‡è¯•

```jsx
// å¸¦é‡è¯•çš„Loader
async function retryableLoader({ params }, retryCount = 0) {
  const MAX_RETRIES = 3;
  const RETRY_DELAY = 1000;

  try {
    const response = await fetch(`/api/data/${params.id}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    return response.json();
    
  } catch (error) {
    if (retryCount < MAX_RETRIES) {
      console.log(`Retry attempt ${retryCount + 1} of ${MAX_RETRIES}`);
      
      // æŒ‡æ•°é€€é¿
      const delay = RETRY_DELAY * Math.pow(2, retryCount);
      await new Promise(resolve => setTimeout(resolve, delay));
      
      return retryableLoader({ params }, retryCount + 1);
    }
    
    // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
    throw new Response(
      `Failed to load data after ${MAX_RETRIES} attempts`,
      { status: 500 }
    );
  }
}

// å¸¦é‡è¯•UIçš„é”™è¯¯è¾¹ç•Œ
function RetryableErrorBoundary() {
  const error = useRouteError();
  const navigate = useNavigate();
  const [retrying, setRetrying] = useState(false);
  const [retryCount, setRetryCount] = useState(0);

  const handleRetry = async () => {
    setRetrying(true);
    setRetryCount(prev => prev + 1);

    // å»¶è¿Ÿåé‡è¯•
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    navigate(0); // é‡æ–°åŠ è½½å½“å‰è·¯ç”±
  };

  return (
    <div className="retryable-error">
      <h1>Something went wrong</h1>
      <p>{error.data || error.message}</p>

      {retryCount > 0 && (
        <p className="retry-info">
          Retry attempts: {retryCount}
        </p>
      )}

      <div className="error-actions">
        <button 
          onClick={handleRetry} 
          disabled={retrying}
        >
          {retrying ? 'Retrying...' : 'Try Again'}
        </button>

        <button onClick={() => navigate(-1)}>
          Go Back
        </button>

        {retryCount >= 3 && (
          <Link to="/support">
            Contact Support
          </Link>
        )}
      </div>

      {retrying && (
        <div className="retry-progress">
          <div className="spinner" />
          <p>Retrying...</p>
        </div>
      )}
    </div>
  );
}
```

### é™çº§å¤„ç†

```jsx
// å¸¦é™çº§çš„Loader
async function fallbackLoader({ params }) {
  try {
    // å°è¯•ä»ä¸»APIåŠ è½½
    const response = await fetch(`/api/v2/data/${params.id}`);
    
    if (!response.ok) {
      throw new Error('Primary API failed');
    }
    
    return {
      data: await response.json(),
      source: 'primary'
    };
    
  } catch (primaryError) {
    console.warn('Primary API failed, trying fallback...', primaryError);
    
    try {
      // å°è¯•ä»å¤‡ç”¨APIåŠ è½½
      const fallbackResponse = await fetch(`/api/v1/data/${params.id}`);
      
      if (!fallbackResponse.ok) {
        throw new Error('Fallback API failed');
      }
      
      return {
        data: await fallbackResponse.json(),
        source: 'fallback',
        warning: 'Using older API version'
      };
      
    } catch (fallbackError) {
      console.error('Both APIs failed', fallbackError);
      
      // å°è¯•ä»ç¼“å­˜åŠ è½½
      const cached = getCachedData(params.id);
      if (cached) {
        return {
          data: cached,
          source: 'cache',
          warning: 'Showing cached data - may be outdated'
        };
      }
      
      // æ‰€æœ‰é€‰é¡¹éƒ½å¤±è´¥äº†
      throw new Response(
        'Unable to load data from any source',
        { status: 503 }
      );
    }
  }
}

// æ˜¾ç¤ºé™çº§è­¦å‘Šçš„ç»„ä»¶
function DataView() {
  const loaderData = useLoaderData();
  const { data, source, warning } = loaderData;

  return (
    <div className="data-view">
      {warning && (
        <div className="degraded-service-warning">
          <strong>Notice:</strong> {warning}
          {source === 'cache' && (
            <button onClick={() => window.location.reload()}>
              Try to Refresh
            </button>
          )}
        </div>
      )}

      <div className="data-content">
        {/* æ¸²æŸ“æ•°æ® */}
        <pre>{JSON.stringify(data, null, 2)}</pre>
      </div>

      {source !== 'primary' && (
        <div className="data-source-info">
          Data source: {source}
        </div>
      )}
    </div>
  );
}
```

### éƒ¨åˆ†å¤±è´¥å¤„ç†

```jsx
// å¤„ç†éƒ¨åˆ†æ•°æ®åŠ è½½å¤±è´¥
async function partialFailureLoader({ params }) {
  const results = {
    critical: null,
    optional: [],
    errors: []
  };

  // å…³é”®æ•°æ®å¿…é¡»æˆåŠŸ
  try {
    results.critical = await fetch(`/api/critical/${params.id}`)
      .then(r => r.json());
  } catch (error) {
    throw new Response('Failed to load critical data', { status: 500 });
  }

  // å¯é€‰æ•°æ®å…è®¸å¤±è´¥
  const optionalPromises = [
    fetch(`/api/optional1/${params.id}`).then(r => r.json()),
    fetch(`/api/optional2/${params.id}`).then(r => r.json()),
    fetch(`/api/optional3/${params.id}`).then(r => r.json())
  ];

  const optionalResults = await Promise.allSettled(optionalPromises);

  optionalResults.forEach((result, index) => {
    if (result.status === 'fulfilled') {
      results.optional.push(result.value);
    } else {
      results.errors.push({
        source: `optional${index + 1}`,
        error: result.reason.message
      });
    }
  });

  return results;
}

// æ˜¾ç¤ºéƒ¨åˆ†å¤±è´¥çš„ç»„ä»¶
function PartialDataView() {
  const { critical, optional, errors } = useLoaderData();

  return (
    <div className="partial-data-view">
      {/* å…³é”®æ•°æ®æ€»æ˜¯æ˜¾ç¤º */}
      <section className="critical-section">
        <h2>Main Content</h2>
        <div>{critical.content}</div>
      </section>

      {/* å¯é€‰æ•°æ® */}
      {optional.length > 0 && (
        <section className="optional-section">
          <h2>Additional Information</h2>
          {optional.map((item, index) => (
            <div key={index}>{item.content}</div>
          ))}
        </section>
      )}

      {/* é”™è¯¯æç¤º */}
      {errors.length > 0 && (
        <div className="partial-errors">
          <p>Some content could not be loaded:</p>
          <ul>
            {errors.map((error, index) => (
              <li key={index}>
                {error.source}: {error.error}
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
}
```

## é”™è¯¯æŠ¥å‘Šå’Œç›‘æ§

### é”™è¯¯æ—¥å¿—è®°å½•

```jsx
// é”™è¯¯æ—¥å¿—æœåŠ¡
class ErrorLogger {
  constructor() {
    this.logs = [];
    this.maxLogs = 100;
  }

  log(error, context = {}) {
    const logEntry = {
      timestamp: new Date().toISOString(),
      error: {
        message: error.message,
        stack: error.stack,
        name: error.name
      },
      context: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        ...context
      }
    };

    this.logs.push(logEntry);

    // é™åˆ¶æ—¥å¿—æ•°é‡
    if (this.logs.length > this.maxLogs) {
      this.logs.shift();
    }

    // å‘é€åˆ°æœåŠ¡å™¨
    this.sendToServer(logEntry);

    return logEntry;
  }

  async sendToServer(logEntry) {
    try {
      await fetch('/api/errors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(logEntry)
      });
    } catch (error) {
      console.error('Failed to send error log:', error);
    }
  }

  getLogs() {
    return [...this.logs];
  }

  clearLogs() {
    this.logs = [];
  }
}

const errorLogger = new ErrorLogger();

// å¸¦æ—¥å¿—çš„é”™è¯¯è¾¹ç•Œ
function LoggingErrorBoundary() {
  const error = useRouteError();
  const location = useLocation();
  const { user } = useAuth();

  useEffect(() => {
    // è®°å½•é”™è¯¯
    errorLogger.log(error, {
      route: location.pathname,
      userId: user?.id,
      userRole: user?.role,
      isRouteError: isRouteErrorResponse(error),
      status: isRouteErrorResponse(error) ? error.status : undefined
    });
  }, [error, location, user]);

  return (
    <div className="error-page">
      <h1>Something went wrong</h1>
      <p>We've been notified and are working on a fix.</p>

      {process.env.NODE_ENV === 'development' && (
        <details className="error-details">
          <summary>Error Details</summary>
          <pre>{JSON.stringify({
            message: error.message,
            stack: error.stack,
            location: location.pathname
          }, null, 2)}</pre>
        </details>
      )}

      <button onClick={() => window.location.reload()}>
        Try Again
      </button>
    </div>
  );
}
```

### é›†æˆç¬¬ä¸‰æ–¹é”™è¯¯ç›‘æ§

```jsx
// Sentryé›†æˆ
import * as Sentry from '@sentry/react';

// åˆå§‹åŒ–Sentry
Sentry.init({
  dsn: process.env.REACT_APP_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  beforeSend(event, hint) {
    // è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
    if (event.user) {
      delete event.user.email;
      delete event.user.ip_address;
    }
    return event;
  }
});

// Sentryé”™è¯¯è¾¹ç•Œ
function SentryErrorBoundary() {
  const error = useRouteError();
  const location = useLocation();

  useEffect(() => {
    // å‘é€é”™è¯¯åˆ°Sentry
    Sentry.captureException(error, {
      contexts: {
        router: {
          location: location.pathname,
          search: location.search
        }
      },
      tags: {
        errorType: isRouteErrorResponse(error) ? 'route' : 'runtime',
        status: isRouteErrorResponse(error) ? error.status : undefined
      }
    });
  }, [error, location]);

  return (
    <div className="error-page">
      <h1>Oops! Something went wrong</h1>
      <p>Our team has been notified and is working on a fix.</p>
      
      <button onClick={() => {
        Sentry.showReportDialog({
          eventId: Sentry.lastEventId(),
          user: {
            name: 'User',
            email: ''
          }
        });
      }}>
        Report Feedback
      </button>
    </div>
  );
}

// è‡ªå®šä¹‰é”™è¯¯ç›‘æ§
class ErrorMonitor {
  constructor() {
    this.errors = [];
    this.listeners = [];
  }

  capture(error, context = {}) {
    const errorData = {
      id: Date.now(),
      timestamp: new Date().toISOString(),
      error: {
        message: error.message,
        stack: error.stack,
        name: error.name
      },
      context,
      userAgent: navigator.userAgent,
      url: window.location.href
    };

    this.errors.push(errorData);
    this.notifyListeners(errorData);

    // å‘é€åˆ°ç›‘æ§æœåŠ¡
    this.sendToMonitoring(errorData);
  }

  subscribe(listener) {
    this.listeners.push(listener);
    return () => {
      this.listeners = this.listeners.filter(l => l !== listener);
    };
  }

  notifyListeners(errorData) {
    this.listeners.forEach(listener => {
      try {
        listener(errorData);
      } catch (error) {
        console.error('Error in error listener:', error);
      }
    });
  }

  async sendToMonitoring(errorData) {
    try {
      await fetch('/api/monitoring/errors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(errorData)
      });
    } catch (error) {
      console.error('Failed to send error to monitoring:', error);
    }
  }

  getErrors() {
    return [...this.errors];
  }

  clearErrors() {
    this.errors = [];
  }
}

const errorMonitor = new ErrorMonitor();

// é”™è¯¯ç›‘æ§Hook
function useErrorMonitoring() {
  const [errors, setErrors] = useState([]);

  useEffect(() => {
    const unsubscribe = errorMonitor.subscribe((errorData) => {
      setErrors(prev => [...prev, errorData].slice(-10)); // ä¿ç•™æœ€æ–°10ä¸ªé”™è¯¯
    });

    return unsubscribe;
  }, []);

  return {
    errors,
    clearErrors: () => {
      setErrors([]);
      errorMonitor.clearErrors();
    }
  };
}

// é”™è¯¯ç›‘æ§é¢æ¿
function ErrorMonitoringPanel() {
  const { errors, clearErrors } = useErrorMonitoring();

  if (process.env.NODE_ENV !== 'development') {
    return null;
  }

  return (
    <div className="error-monitoring-panel">
      <div className="panel-header">
        <h3>Error Monitor ({errors.length})</h3>
        <button onClick={clearErrors}>Clear</button>
      </div>

      <div className="errors-list">
        {errors.map(error => (
          <div key={error.id} className="error-item">
            <div className="error-time">
              {new Date(error.timestamp).toLocaleTimeString()}
            </div>
            <div className="error-message">
              {error.error.message}
            </div>
            <div className="error-location">
              {error.context.route}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
```

## ç”¨æˆ·å‹å¥½çš„é”™è¯¯é¡µé¢

### äº¤äº’å¼é”™è¯¯é¡µé¢

```jsx
// ä¸°å¯Œçš„é”™è¯¯é¡µé¢ç»„ä»¶
function RichErrorPage() {
  const error = useRouteError();
  const navigate = useNavigate();
  const [feedback, setFeedback] = useState('');
  const [submitted, setSubmitted] = useState(false);

  const handleSubmitFeedback = async () => {
    try {
      await fetch('/api/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          error: error.message,
          feedback,
          url: window.location.href,
          timestamp: new Date().toISOString()
        })
      });

      setSubmitted(true);
      setTimeout(() => setSubmitted(false), 3000);
    } catch (error) {
      console.error('Failed to submit feedback:', error);
    }
  };

  return (
    <div className="rich-error-page">
      <div className="error-container">
        <div className="error-icon">
          <ErrorIllustration type={getErrorType(error)} />
        </div>

        <h1>Oops! Something went wrong</h1>
        
        <p className="error-message">
          {getErrorMessage(error)}
        </p>

        {/* å»ºè®®çš„æ“ä½œ */}
        <div className="suggested-actions">
          <h3>You can try:</h3>
          <div className="actions-grid">
            <button 
              className="action-card"
              onClick={() => navigate(0)}
            >
              <span className="action-icon">ğŸ”„</span>
              <span className="action-text">Refresh the page</span>
            </button>

            <button 
              className="action-card"
              onClick={() => navigate(-1)}
            >
              <span className="action-icon">â¬…ï¸</span>
              <span className="action-text">Go back</span>
            </button>

            <button 
              className="action-card"
              onClick={() => navigate('/')}
            >
              <span className="action-icon">ğŸ </span>
              <span className="action-text">Go to homepage</span>
            </button>

            <Link to="/help" className="action-card">
              <span className="action-icon">â“</span>
              <span className="action-text">Visit help center</span>
            </Link>
          </div>
        </div>

        {/* åé¦ˆè¡¨å• */}
        <div className="error-feedback">
          <h3>Help us improve</h3>
          <p>Let us know what happened:</p>
          
          <textarea
            value={feedback}
            onChange={(e) => setFeedback(e.target.value)}
            placeholder="Describe what you were trying to do..."
            rows="4"
          />

          <button 
            onClick={handleSubmitFeedback}
            disabled={!feedback || submitted}
          >
            {submitted ? 'Thank you!' : 'Send Feedback'}
          </button>
        </div>

        {/* å¸¸è§é—®é¢˜ */}
        <div className="error-faq">
          <h3>Common questions:</h3>
          <details>
            <summary>Why did this happen?</summary>
            <p>This error occurred because {getErrorExplanation(error)}</p>
          </details>
          
          <details>
            <summary>Will my data be lost?</summary>
            <p>No, your data is safe. We automatically save your work.</p>
          </details>
          
          <details>
            <summary>How long will this take to fix?</summary>
            <p>Our team has been notified and is working on a solution.</p>
          </details>
        </div>
      </div>
    </div>
  );
}

// é”™è¯¯ç±»å‹å›¾æ ‡
function ErrorIllustration({ type }) {
  const illustrations = {
    '404': 'ğŸ”',
    '403': 'ğŸ”’',
    '500': 'ğŸ”§',
    'network': 'ğŸ“¡',
    'default': 'âš ï¸'
  };

  return (
    <div className="error-illustration">
      {illustrations[type] || illustrations.default}
    </div>
  );
}

// è·å–ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
function getErrorMessage(error) {
  if (isRouteErrorResponse(error)) {
    const messages = {
      404: "We couldn't find the page you're looking for.",
      403: "You don't have permission to access this page.",
      401: "Please sign in to continue.",
      500: "Something went wrong on our end.",
      503: "This service is temporarily unavailable."
    };

    return messages[error.status] || error.data;
  }

  return "An unexpected error occurred. Please try again.";
}

// è·å–é”™è¯¯ç±»å‹
function getErrorType(error) {
  if (isRouteErrorResponse(error)) {
    return error.status.toString();
  }

  if (error.message?.includes('network')) {
    return 'network';
  }

  return 'default';
}

// è·å–é”™è¯¯è§£é‡Š
function getErrorExplanation(error) {
  if (isRouteErrorResponse(error)) {
    const explanations = {
      404: "the page you requested doesn't exist or has been moved.",
      403: "you don't have the necessary permissions.",
      500: "there was a problem on our server.",
      503: "our service is temporarily down for maintenance."
    };

    return explanations[error.status] || "of an unexpected issue.";
  }

  return "of an unexpected technical issue.";
}
```

### å“ç‰ŒåŒ–é”™è¯¯é¡µé¢

```jsx
// å“ç‰ŒåŒ–çš„404é¡µé¢
function Custom404Page() {
  const navigate = useNavigate();
  const [searchQuery, setSearchQuery] = useState('');

  const handleSearch = (e) => {
    e.preventDefault();
    if (searchQuery.trim()) {
      navigate(`/search?q=${encodeURIComponent(searchQuery)}`);
    }
  };

  return (
    <div className="custom-404">
      <div className="error-content">
        <div className="error-animation">
          <Lost404Animation />
        </div>

        <h1>Page Not Found</h1>
        <p className="error-subtitle">
          Looks like you've ventured into uncharted territory!
        </p>

        {/* æœç´¢æ  */}
        <form onSubmit={handleSearch} className="error-search">
          <input
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="What are you looking for?"
          />
          <button type="submit">Search</button>
        </form>

        {/* çƒ­é—¨é“¾æ¥ */}
        <div className="popular-links">
          <h3>Popular pages:</h3>
          <div className="links-grid">
            <Link to="/" className="link-card">
              <span>ğŸ </span>
              <span>Home</span>
            </Link>
            <Link to="/products" className="link-card">
              <span>ğŸ›ï¸</span>
              <span>Products</span>
            </Link>
            <Link to="/about" className="link-card">
              <span>â„¹ï¸</span>
              <span>About</span>
            </Link>
            <Link to="/contact" className="link-card">
              <span>ğŸ“§</span>
              <span>Contact</span>
            </Link>
          </div>
        </div>
      </div>
    </div>
  );
}

// å“ç‰ŒåŒ–çš„ç»´æŠ¤é¡µé¢
function MaintenancePage() {
  const [timeRemaining, setTimeRemaining] = useState(null);

  useEffect(() => {
    // è·å–ç»´æŠ¤ç»“æŸæ—¶é—´
    fetch('/api/maintenance/status')
      .then(r => r.json())
      .then(data => {
        if (data.endTime) {
          const end = new Date(data.endTime);
          updateCountdown(end);

          const interval = setInterval(() => {
            updateCountdown(end);
          }, 1000);

          return () => clearInterval(interval);
        }
      });
  }, []);

  const updateCountdown = (endTime) => {
    const now = new Date();
    const diff = endTime - now;

    if (diff <= 0) {
      window.location.reload();
      return;
    }

    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

    setTimeRemaining({ hours, minutes, seconds });
  };

  return (
    <div className="maintenance-page">
      <div className="maintenance-content">
        <MaintenanceAnimation />

        <h1>We'll be right back!</h1>
        <p>We're making some improvements to serve you better.</p>

        {timeRemaining && (
          <div className="countdown">
            <div className="countdown-item">
              <span className="countdown-value">{timeRemaining.hours}</span>
              <span className="countdown-label">Hours</span>
            </div>
            <div className="countdown-item">
              <span className="countdown-value">{timeRemaining.minutes}</span>
              <span className="countdown-label">Minutes</span>
            </div>
            <div className="countdown-item">
              <span className="countdown-value">{timeRemaining.seconds}</span>
              <span className="countdown-label">Seconds</span>
            </div>
          </div>
        )}

        <div className="maintenance-info">
          <p>In the meantime:</p>
          <ul>
            <li>Follow us on social media for updates</li>
            <li>Check our status page for real-time information</li>
            <li>Contact support if you need immediate assistance</li>
          </ul>
        </div>

        <div className="social-links">
          <a href="https://twitter.com/yourapp" target="_blank" rel="noopener noreferrer">
            Twitter
          </a>
          <a href="https://facebook.com/yourapp" target="_blank" rel="noopener noreferrer">
            Facebook
          </a>
          <a href="https://status.yourapp.com" target="_blank" rel="noopener noreferrer">
            Status Page
          </a>
        </div>
      </div>
    </div>
  );
}
```

## é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

### 1. é”™è¯¯è¾¹ç•Œå±‚æ¬¡è®¾è®¡

```jsx
// åˆ†å±‚é”™è¯¯å¤„ç†ç­–ç•¥
const errorBoundaryStrategy = {
  // å…¨å±€å±‚ - æ•è·è‡´å‘½é”™è¯¯
  global: {
    purpose: 'å¤„ç†åº”ç”¨çº§é”™è¯¯ï¼Œé˜²æ­¢æ•´ä¸ªåº”ç”¨å´©æºƒ',
    features: ['é”™è¯¯æ—¥å¿—', 'ç”¨æˆ·åé¦ˆ', 'é‡å¯åº”ç”¨'],
    example: '<RootErrorBoundary />'
  },

  // å¸ƒå±€å±‚ - ä¿ç•™å¯¼èˆª
  layout: {
    purpose: 'å¤„ç†å¸ƒå±€å†…å®¹é”™è¯¯ï¼Œä¿ç•™åº”ç”¨æ¡†æ¶',
    features: ['ä¿ç•™å¯¼èˆª', 'é”™è¯¯æ¢å¤', 'éƒ¨åˆ†åˆ·æ–°'],
    example: '<LayoutErrorBoundary />'
  },

  // åŠŸèƒ½å±‚ - éš”ç¦»åŠŸèƒ½æ¨¡å—
  feature: {
    purpose: 'éš”ç¦»å•ä¸ªåŠŸèƒ½æ¨¡å—çš„é”™è¯¯',
    features: ['é™çº§æ˜¾ç¤º', 'é‡è¯•æœºåˆ¶', 'æ›¿ä»£æ–¹æ¡ˆ'],
    example: '<FeatureErrorBoundary />'
  },

  // ç»„ä»¶å±‚ - æœ€ç»†ç²’åº¦
  component: {
    purpose: 'å¤„ç†å•ä¸ªç»„ä»¶é”™è¯¯ï¼Œä¸å½±å“å…¶ä»–ç»„ä»¶',
    features: ['å ä½ç¬¦', 'é»˜è®¤å€¼', 'é™é»˜å¤±è´¥'],
    example: '<ComponentErrorBoundary />'
  }
};
```

### 2. é”™è¯¯ä¿¡æ¯æœ¬åœ°åŒ–

```jsx
// å¤šè¯­è¨€é”™è¯¯æ¶ˆæ¯
const errorMessages = {
  en: {
    404: 'Page not found',
    403: 'Access denied',
    500: 'Server error',
    network: 'Network error',
    retry: 'Try again',
    goBack: 'Go back',
    goHome: 'Go to homepage'
  },
  zh: {
    404: 'é¡µé¢æœªæ‰¾åˆ°',
    403: 'è®¿é—®è¢«æ‹’ç»',
    500: 'æœåŠ¡å™¨é”™è¯¯',
    network: 'ç½‘ç»œé”™è¯¯',
    retry: 'é‡è¯•',
    goBack: 'è¿”å›',
    goHome: 'è¿”å›é¦–é¡µ'
  }
};

function LocalizedErrorBoundary() {
  const error = useRouteError();
  const { language } = useLanguage();

  const messages = errorMessages[language] || errorMessages.en;

  return (
    <div className="error-page">
      <h1>{messages[error.status] || messages[500]}</h1>
      <div className="error-actions">
        <button onClick={() => navigate(0)}>
          {messages.retry}
        </button>
        <button onClick={() => navigate(-1)}>
          {messages.goBack}
        </button>
        <button onClick={() => navigate('/')}>
          {messages.goHome}
        </button>
      </div>
    </div>
  );
}
```

### 3. æ€§èƒ½ç›‘æ§

```jsx
// é”™è¯¯æ€§èƒ½è¿½è¸ª
class ErrorPerformanceTracker {
  constructor() {
    this.metrics = [];
  }

  trackError(error, context = {}) {
    const metric = {
      timestamp: performance.now(),
      error: {
        message: error.message,
        type: error.name
      },
      context,
      performance: {
        memory: performance.memory?.usedJSHeapSize,
        navigation: performance.getEntriesByType('navigation')[0]
      }
    };

    this.metrics.push(metric);

    // å‘é€åˆ°åˆ†ææœåŠ¡
    this.sendMetrics(metric);
  }

  async sendMetrics(metric) {
    try {
      await fetch('/api/metrics/errors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(metric)
      });
    } catch (error) {
      console.error('Failed to send error metrics:', error);
    }
  }

  getMetrics() {
    return [...this.metrics];
  }
}

const errorTracker = new ErrorPerformanceTracker();
```

## æ€»ç»“

React Router v6çš„é”™è¯¯å¤„ç†æœºåˆ¶æä¾›äº†å®Œå–„çš„è§£å†³æ–¹æ¡ˆï¼š

1. **errorElement**ï¼šè·¯ç”±çº§é”™è¯¯è¾¹ç•Œ
2. **useRouteError**ï¼šè·å–é”™è¯¯è¯¦æƒ…
3. **åµŒå¥—å¤„ç†**ï¼šå¤šå±‚æ¬¡é”™è¯¯éš”ç¦»
4. **é”™è¯¯æ¢å¤**ï¼šé‡è¯•ã€é™çº§ã€éƒ¨åˆ†å¤±è´¥å¤„ç†
5. **ç”¨æˆ·ä½“éªŒ**ï¼šå‹å¥½çš„é”™è¯¯é¡µé¢å’Œäº¤äº’
6. **ç›‘æ§æ—¥å¿—**ï¼šå®Œæ•´çš„é”™è¯¯è¿½è¸ªå’ŒæŠ¥å‘Š

åˆç†çš„é”™è¯¯å¤„ç†ç­–ç•¥èƒ½å¤Ÿæ˜¾è‘—æå‡åº”ç”¨çš„å¥å£®æ€§å’Œç”¨æˆ·ä½“éªŒã€‚
